<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>✅ Menu Click Verification - Build 20250818</title>
  <link rel="stylesheet" href="style.css?v=20250818">
  <style>
    .verification-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 350px;
      background: rgba(248, 249, 250, 0.95);
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 20px;
      z-index: 1000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .test-item {
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #6c757d;
    }
    .test-pass { background: #d4edda; border-left-color: #28a745; color: #155724; }
    .test-fail { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
    .test-pending { background: #fff3cd; border-left-color: #ffc107; color: #856404; }
    .instruction { background: #e7f3ff; color: #0c5460; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
    .menu-counter {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div class="page-container">
  <main class="main-column">
    <header class="post-header">
      <h1>✅ Menu Click Verification Test</h1>
      <div class="post-date">Build 20250818 - Final verification of menu click fixes</div>
    </header>
    <section class="post-content">
      <h2>🎯 Objective: Verify menu dropdowns work correctly</h2>
      
      <p>This page tests the comprehensive menu click fixes implemented to resolve the persistent taskbar dropdown issues.</p>
      
      <h3>🔧 Fixes Applied:</h3>
      <ul>
        <li>Event listener cleanup to prevent conflicts</li>
        <li>Centralized menu state management</li>
        <li>Robust initialization with retry logic</li>
        <li>Emergency recovery system</li>
        <li>Proper event handling and propagation</li>
      </ul>
      
      <h3>📋 Expected Behavior:</h3>
      <ul>
        <li>Click any menu label → dropdown appears</li>
        <li>Click another menu → previous closes, new one opens</li>
        <li>Click outside menus → all close</li>
        <li>No console errors during operation</li>
      </ul>
    </section>
  </main>
</div>

<div class="verification-panel">
  <h4>🧪 Live Verification</h4>
  
  <div class="instruction">
    <strong>Instructions:</strong><br>
    1. Try clicking each menu in the taskbar above<br>
    2. Watch the test results update in real-time<br>
    3. All tests should pass ✅
  </div>
  
  <div class="menu-counter" id="menu-counter">
    Detecting menus...
  </div>
  
  <div id="test-results">
    <div class="test-item test-pending" id="structure-test">
      <strong>Menu Structure:</strong> <span id="structure-status">Checking...</span>
    </div>
    <div class="test-item test-pending" id="listeners-test">
      <strong>Event Listeners:</strong> <span id="listeners-status">Checking...</span>
    </div>
    <div class="test-item test-pending" id="click-test">
      <strong>Click Functionality:</strong> <span id="click-status">Click menus to test</span>
    </div>
    <div class="test-item test-pending" id="state-test">
      <strong>State Management:</strong> <span id="state-status">Monitoring...</span>
    </div>
  </div>
  
  <div style="margin-top: 15px; text-align: center;">
    <button onclick="runAllTests()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">🔄 Re-run Tests</button>
  </div>
</div>

<!-- PPPage Modular System -->
<script src="modules/core.js?v=20250818"></script>
<script src="modules/posts.js?v=20250818"></script>
<script src="modules/navigation.js?v=20250818"></script>
<script src="modules/editor.js?v=20250818"></script>
<script src="modules/theme.js?v=20250818"></script>
<script src="modules/taskbar.js?v=20250818"></script>
<script src="modules/console.js?v=20250818"></script>
<script src="modules/app.js?v=20250818"></script>

<script>
let testState = {
  clicksDetected: 0,
  menusOpened: 0,
  menusClosed: 0,
  errors: 0
};

function updateTestStatus(testId, status, message) {
  const element = document.getElementById(testId);
  const statusSpan = document.getElementById(testId.replace('-test', '-status'));
  
  if (element && statusSpan) {
    element.className = `test-item test-${status}`;
    statusSpan.textContent = message;
  }
}

function updateMenuCounter() {
  const counter = document.getElementById('menu-counter');
  const menuItems = document.querySelectorAll('.menu-item');
  const openMenus = document.querySelectorAll('.menu-item.open');
  
  counter.innerHTML = `
    📊 Menu Count: ${menuItems.length}<br>
    🖱️ Clicks: ${testState.clicksDetected}<br>
    📂 Opened: ${testState.menusOpened}<br>
    📁 Closed: ${testState.menusClosed}<br>
    ❌ Errors: ${testState.errors}<br>
    🔓 Currently Open: ${openMenus.length}
  `;
}

function testMenuStructure() {
  const menuItems = document.querySelectorAll('.menu-item');
  
  if (menuItems.length === 0) {
    updateTestStatus('structure-test', 'fail', 'No menu items found');
    return false;
  }
  
  let validMenus = 0;
  menuItems.forEach(item => {
    const label = item.querySelector('.label');
    const dropdown = item.querySelector('.menu-dropdown');
    
    if (label && dropdown) {
      validMenus++;
    }
  });
  
  if (validMenus === menuItems.length) {
    updateTestStatus('structure-test', 'pass', `${validMenus} valid menus found`);
    return true;
  } else {
    updateTestStatus('structure-test', 'fail', `${validMenus}/${menuItems.length} valid menus`);
    return false;
  }
}

function testEventListeners() {
  const menuItems = document.querySelectorAll('.menu-item');
  let hasListeners = 0;
  
  menuItems.forEach(item => {
    const label = item.querySelector('.label');
    if (label && label._taskbarClickHandler) {
      hasListeners++;
    }
  });
  
  if (hasListeners === menuItems.length) {
    updateTestStatus('listeners-test', 'pass', `${hasListeners} listeners attached`);
    return true;
  } else {
    updateTestStatus('listeners-test', 'fail', `${hasListeners}/${menuItems.length} listeners`);
    return false;
  }
}

function runAllTests() {
  console.log('🧪 Running all verification tests...');
  
  testState = { clicksDetected: 0, menusOpened: 0, menusClosed: 0, errors: 0 };
  
  setTimeout(() => testMenuStructure(), 100);
  setTimeout(() => testEventListeners(), 200);
  setTimeout(() => updateMenuCounter(), 300);
}

// Monitor all clicks on menu labels
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('label')) {
    testState.clicksDetected++;
    console.log(`🖱️ Menu click detected: "${e.target.textContent.trim()}"`);
    
    setTimeout(() => {
      const menuItem = e.target.closest('.menu-item');
      const isOpen = menuItem.classList.contains('open');
      
      if (isOpen) {
        testState.menusOpened++;
        updateTestStatus('click-test', 'pass', `Menus responding to clicks`);
      }
      
      updateMenuCounter();
    }, 50);
  }
}, true);

// Monitor menu state changes
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
      const target = mutation.target;
      if (target.classList.contains('menu-item')) {
        const isOpen = target.classList.contains('open');
        
        if (isOpen) {
          testState.menusOpened++;
        } else {
          testState.menusClosed++;
        }
        
        // Check state management
        const openMenus = document.querySelectorAll('.menu-item.open');
        if (openMenus.length <= 1) {
          updateTestStatus('state-test', 'pass', 'State management working');
        } else {
          updateTestStatus('state-test', 'fail', `${openMenus.length} menus open simultaneously`);
        }
        
        updateMenuCounter();
      }
    }
  });
});

// Monitor console errors
const originalError = console.error;
console.error = function(...args) {
  testState.errors++;
  updateMenuCounter();
  originalError.apply(console, args);
};

// Start monitoring when page loads
setTimeout(() => {
  console.log('🚀 Menu verification system started');
  
  // Start observing menu items
  const menuItems = document.querySelectorAll('.menu-item');
  menuItems.forEach(item => {
    observer.observe(item, { attributes: true });
  });
  
  // Run initial tests
  runAllTests();
  
  console.log('👀 Monitoring menu interactions...');
}, 2000);
</script>

</body>
</html>
