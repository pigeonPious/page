<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Server Taskbar Test</title>
    <link rel="stylesheet" href="style.css?v=20250823">
    <style>
        .server-test-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            z-index: 9999;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .server-test-panel h3 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 14px;
        }
        .test-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-item.pass { background: #d4edda; color: #155724; }
        .test-item.fail { background: #f8d7da; color: #721c24; }
        .test-item.pending { background: #fff3cd; color: #856404; }
        .test-btn {
            padding: 4px 8px;
            font-size: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }
        .test-btn.primary { background: #007bff; color: white; }
        .test-btn.secondary { background: #6c757d; color: white; }
        .test-btn.success { background: #28a745; color: white; }
        .test-btn.warning { background: #ffc107; color: black; }
        .console-mini {
            background: #000;
            color: #0f0;
            padding: 8px;
            font-size: 10px;
            height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 3px;
        }
        .url-info {
            background: #e9ecef;
            padding: 5px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-size: 10px;
        }
    </style>
</head>
<body>
<!-- Taskbar will be loaded by modular system -->

<div class="page-container">
    <main class="main-column">
        <header class="post-header">
            <h1 class="post-title">Local Server Taskbar Test</h1>
            <div class="post-date">Server Test - Build: alpine (20250823)</div>
        </header>
        
        <section class="post-content">
            <h2>Local Server Testing</h2>
            <p>This page tests the taskbar functionality when served over HTTP instead of file:// protocol.</p>
            
            <h3>What This Tests:</h3>
            <ul>
                <li><strong>HTTP vs File Protocol:</strong> Module loading over HTTP</li>
                <li><strong>CORS Issues:</strong> Cross-origin restrictions</li>
                <li><strong>Cache Busting:</strong> Version parameter effectiveness</li>
                <li><strong>Real-world Conditions:</strong> Actual server environment</li>
            </ul>
            
            <h3>Server Information:</h3>
            <div id="server-info">
                <p><strong>Protocol:</strong> <span id="protocol">Loading...</span></p>
                <p><strong>Host:</strong> <span id="host">Loading...</span></p>
                <p><strong>Port:</strong> <span id="port">Loading...</span></p>
                <p><strong>Base URL:</strong> <span id="base-url">Loading...</span></p>
            </div>
            
            <h3>Testing Instructions:</h3>
            <ol>
                <li>Verify the server is running at localhost:9000</li>
                <li>Check that all modules load without CORS errors</li>
                <li>Test taskbar menu interactions</li>
                <li>Try custom and random themes</li>
                <li>Refresh the page and verify persistence</li>
                <li>Check browser console for any errors</li>
            </ol>
            
            <h3>Network Monitoring:</h3>
            <p>Open browser DevTools (F12) ‚Üí Network tab to monitor:</p>
            <ul>
                <li>Module JS files loading with 200 status</li>
                <li>CSS file loading with proper version</li>
                <li>No 404 errors for missing files</li>
                <li>Cache-Control headers working</li>
            </ul>
        </section>
    </main>
</div>

<div class="server-test-panel">
    <h3>üåê Server Test Panel</h3>
    
    <div class="url-info">
        <strong>Current URL:</strong><br>
        <span id="current-url">Loading...</span>
    </div>
    
    <div id="test-results">
        <div class="test-item pending" id="protocol-test">
            <span>HTTP Protocol</span>
            <span id="protocol-status">Testing...</span>
        </div>
        <div class="test-item pending" id="modules-test">
            <span>Module Loading</span>
            <span id="modules-status">Testing...</span>
        </div>
        <div class="test-item pending" id="taskbar-test">
            <span>Taskbar Function</span>
            <span id="taskbar-status">Testing...</span>
        </div>
        <div class="test-item pending" id="themes-test">
            <span>Theme System</span>
            <span id="themes-status">Testing...</span>
        </div>
        <div class="test-item pending" id="persistence-test">
            <span>Page Persistence</span>
            <span id="persistence-status">Manual</span>
        </div>
    </div>
    
    <div style="margin: 10px 0;">
        <button class="test-btn primary" onclick="runServerTests()">Run Tests</button>
        <button class="test-btn secondary" onclick="testThemes()">Test Themes</button>
        <button class="test-btn warning" onclick="location.reload()">Reload</button>
        <button class="test-btn success" onclick="openNetworkTab()">Network</button>
    </div>
    
    <div class="console-mini" id="server-console"></div>
</div>

<!-- PPPage Modular System -->
<script src="modules/core.js?v=20250823"></script>
<script src="modules/posts.js?v=20250823"></script>
<script src="modules/navigation.js?v=20250823"></script>
<script src="modules/editor.js?v=20250823"></script>
<script src="modules/theme.js?v=20250823"></script>
<script src="modules/taskbar.js?v=20250823"></script>
<script src="modules/console.js?v=20250823"></script>
<script src="modules/app.js?v=20250823"></script>

<script>
let serverTestLog = [];

function serverLog(message) {
    const timestamp = new Date().toTimeString().split(' ')[0];
    const logMessage = `${timestamp}: ${message}`;
    serverTestLog.push(logMessage);
    
    const console = document.getElementById('server-console');
    if (console) {
        console.innerHTML = serverTestLog.slice(-10).join('\n');
        console.scrollTop = console.scrollHeight;
    }
}

function updateServerStatus(testId, status, message) {
    const element = document.getElementById(testId);
    const statusSpan = document.getElementById(testId.replace('-test', '-status'));
    
    if (element && statusSpan) {
        element.className = `test-item ${status}`;
        statusSpan.textContent = message;
    }
}

function displayServerInfo() {
    const url = new URL(window.location.href);
    
    document.getElementById('protocol').textContent = url.protocol;
    document.getElementById('host').textContent = url.hostname;
    document.getElementById('port').textContent = url.port || (url.protocol === 'https:' ? '443' : '80');
    document.getElementById('base-url').textContent = `${url.protocol}//${url.host}`;
    document.getElementById('current-url').textContent = window.location.href;
}

function testServerProtocol() {
    serverLog('=== Testing Server Protocol ===');
    
    const isHTTP = window.location.protocol.startsWith('http');
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    if (isHTTP && isLocalhost) {
        updateServerStatus('protocol-test', 'pass', '‚úì HTTP Local');
        serverLog('‚úÖ Running on HTTP localhost');
    } else if (isHTTP) {
        updateServerStatus('protocol-test', 'pass', '‚úì HTTP');
        serverLog('‚úÖ Running on HTTP');
    } else {
        updateServerStatus('protocol-test', 'fail', '‚úó File Protocol');
        serverLog('‚ùå Running on file:// protocol');
    }
}

function testModuleLoading() {
    serverLog('=== Testing Module Loading ===');
    
    const modules = ['core', 'posts', 'navigation', 'editor', 'theme', 'taskbar', 'console'];
    let loadedModules = 0;
    
    // Check if ppPage core is available
    if (typeof window.ppPage !== 'undefined') {
        loadedModules++;
        serverLog('‚úÖ Core module loaded');
    }
    
    // Check if TaskbarModule is available
    if (typeof window.TaskbarModule !== 'undefined') {
        loadedModules++;
        serverLog('‚úÖ Taskbar module loaded');
    }
    
    // Check if modules are registered in ppPage
    if (window.ppPage && typeof window.ppPage.getModule === 'function') {
        modules.forEach(moduleName => {
            const module = window.ppPage.getModule(moduleName);
            if (module) {
                loadedModules++;
                serverLog(`‚úÖ ${moduleName} module registered`);
            }
        });
    }
    
    if (loadedModules >= 5) {
        updateServerStatus('modules-test', 'pass', `‚úì ${loadedModules} Loaded`);
        serverLog(`‚úÖ ${loadedModules} modules loaded successfully`);
    } else {
        updateServerStatus('modules-test', 'fail', `‚úó ${loadedModules} Only`);
        serverLog(`‚ùå Only ${loadedModules} modules loaded`);
    }
}

function testTaskbarFunction() {
    serverLog('=== Testing Taskbar Function ===');
    
    const menuBar = document.querySelector('.menu-bar');
    if (!menuBar) {
        updateServerStatus('taskbar-test', 'fail', '‚úó Not Found');
        serverLog('‚ùå Taskbar not found');
        return;
    }
    
    const viewMenu = menuBar.querySelector('[data-menu]');
    if (!viewMenu) {
        updateServerStatus('taskbar-test', 'fail', '‚úó Menu Missing');
        serverLog('‚ùå View menu not found');
        return;
    }
    
    // Test click functionality
    viewMenu.click();
    
    setTimeout(() => {
        const menuItem = viewMenu.closest('.menu-item');
        if (menuItem && menuItem.classList.contains('open')) {
            updateServerStatus('taskbar-test', 'pass', '‚úì Functional');
            serverLog('‚úÖ Taskbar menu clicks working');
            
            // Close the menu
            document.body.click();
        } else {
            updateServerStatus('taskbar-test', 'fail', '‚úó No Click');
            serverLog('‚ùå Taskbar menu clicks not working');
        }
    }, 200);
}

function testThemeSystem() {
    serverLog('=== Testing Theme System ===');
    
    const customButton = document.querySelector('[data-mode="custom"]');
    const randomButton = document.querySelector('[data-mode="random"]');
    
    if (!customButton || !randomButton) {
        updateServerStatus('themes-test', 'fail', '‚úó Buttons Missing');
        serverLog('‚ùå Theme buttons not found');
        return;
    }
    
    // Test custom theme
    customButton.click();
    
    setTimeout(() => {
        const hasCustomMode = document.body.classList.contains('custom-mode');
        const hasCustomBg = document.body.style.getPropertyValue('--bg');
        
        if (hasCustomMode || hasCustomBg) {
            serverLog('‚úÖ Custom theme applied');
            
            // Test random theme
            setTimeout(() => {
                randomButton.click();
                
                setTimeout(() => {
                    const newBg = document.body.style.getPropertyValue('--bg');
                    if (newBg && newBg !== hasCustomBg) {
                        updateServerStatus('themes-test', 'pass', '‚úì Working');
                        serverLog('‚úÖ Random theme generated');
                    } else {
                        updateServerStatus('themes-test', 'fail', '‚úó Random Failed');
                        serverLog('‚ùå Random theme failed');
                    }
                }, 300);
            }, 300);
        } else {
            updateServerStatus('themes-test', 'fail', '‚úó Custom Failed');
            serverLog('‚ùå Custom theme failed');
        }
    }, 300);
}

function runServerTests() {
    serverLog('=== Starting Server Tests ===');
    displayServerInfo();
    
    setTimeout(() => testServerProtocol(), 100);
    setTimeout(() => testModuleLoading(), 500);
    setTimeout(() => testTaskbarFunction(), 1000);
    setTimeout(() => testThemeSystem(), 1500);
}

function testThemes() {
    testThemeSystem();
}

function openNetworkTab() {
    serverLog('Open DevTools ‚Üí Network tab to monitor requests');
    // This would typically open DevTools programmatically if possible
    console.log('Open DevTools ‚Üí Network tab to monitor HTTP requests');
}

// Override console.log to capture system messages
const originalConsoleLog = console.log;
console.log = function(...args) {
    originalConsoleLog.apply(console, args);
    serverLog(args.join(' '));
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    displayServerInfo();
    serverLog('Page loaded, waiting for modules...');
    
    // Auto-run tests after modules load
    setTimeout(() => {
        serverLog('Auto-running server tests...');
        runServerTests();
    }, 3000);
});

// Monitor for errors
window.addEventListener('error', (event) => {
    serverLog(`‚ùå Error: ${event.error?.message || event.message}`);
});

// Monitor for network errors
window.addEventListener('unhandledrejection', (event) => {
    serverLog(`‚ùå Promise rejected: ${event.reason}`);
});
</script>
</body>
</html>
