<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔍 Authentication Debug Test</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="menu-bar">
  <div class="menu-bar-inner">
    <div class="menu-star">*</div>
    <div class="menu-item"><div class="label" data-menu>File</div><div class="menu-dropdown"><a class="menu-entry" href="index.html">Back to Blog</a></div></div>
  </div>
</div>

<div style="padding: 40px; max-width: 900px; margin: 0 auto; font-family: monospace;">
  <h1>🔍 Authentication Debug Test</h1>
  
  <div style="background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h2>🧪 Current Status</h2>
    
    <div style="background: #e8e8e8; padding: 15px; margin: 10px 0; border-radius: 3px;">
      <h3>🍪 Cookie Status</h3>
      <div id="cookie-status">Checking cookies...</div>
      <button onclick="debugCookies()" style="margin-top: 10px; padding: 5px 10px;">🔍 Debug Cookies</button>
    </div>
    <p><strong>Issue:</strong> Login works but auth doesn't persist across pages</p>
    <p><strong>Root Cause Found:</strong> Username mismatch</p>
    <p><strong>Repository:</strong> <code>pigeonPious/page.git</code></p>
    <p><strong>Expected Username:</strong> <code>pigeonPious</code></p>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>1. 🔧 Environment Check</h2>
    <button onclick="checkEnvironment()" style="padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer;">Check Environment Variables</button>
    <div id="env-result" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; white-space: pre-wrap;"></div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>2. 🔐 Current Auth Status</h2>
    <button onclick="checkCurrentAuth()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Check Current Authentication</button>
    <div id="auth-result" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; white-space: pre-wrap;"></div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>3. 🚀 OAuth Test Flow</h2>
    <p>This will start the GitHub OAuth flow with debug information:</p>
    <button onclick="startOAuthTest()" style="padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 5px; cursor: pointer;">Start GitHub OAuth Test</button>
    <div id="oauth-result" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; white-space: pre-wrap;"></div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>4. 🍪 Cookie Inspector</h2>
    <button onclick="inspectCookies()" style="padding: 10px 20px; background: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer;">Inspect Current Cookies</button>
    <div id="cookie-result" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; white-space: pre-wrap;"></div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>5. 🧹 Clear Session</h2>
    <button onclick="clearSession()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Clear All Cookies & Session</button>
    <div id="clear-result" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; white-space: pre-wrap;"></div>
  </div>
  
  <div id="debug-log" style="background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-top: 30px;">
    📊 Debug Log - Real-time authentication debugging
═══════════════════════════════════════════════════════════════
  </div>
</div>

<script>
function log(message, type = 'info') {
  const debugLog = document.getElementById('debug-log');
  const timestamp = new Date().toLocaleTimeString();
  const emoji = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warn' ? '⚠️' : '🔍';
  debugLog.textContent += `[${timestamp}] ${emoji} ${message}\n`;
  debugLog.scrollTop = debugLog.scrollHeight;
}

async function checkEnvironment() {
  log('Checking server environment variables...', 'info');
  const resultDiv = document.getElementById('env-result');
  
  try {
    const response = await fetch('/.netlify/functions/debug-env');
    const data = await response.json();
    
    resultDiv.textContent = JSON.stringify(data, null, 2);
    log(`Environment check complete: Admin username = ${data.adminUsername}`, 'success');
    
    if (data.adminUsername === 'piouspigeon') {
      log('⚠️ ISSUE FOUND: Environment variable ADMIN_GITHUB_USERNAME is set to "piouspigeon"', 'warn');
      log('✅ SOLUTION: Environment variable needs to be changed to "pigeonPious"', 'info');
    } else if (data.adminUsername === 'pigeonPious') {
      log('✅ Username is correct in environment', 'success');
    }
  } catch (error) {
    resultDiv.textContent = `Error: ${error.message}`;
    log(`Environment check failed: ${error.message}`, 'error');
  }
}

async function checkCurrentAuth() {
  log('Checking current authentication status...', 'info');
  const resultDiv = document.getElementById('auth-result');
  
  try {
    const response = await fetch('/.netlify/functions/auth-check', {
      credentials: 'include'
    });
    const data = await response.json();
    
    resultDiv.textContent = JSON.stringify(data, null, 2);
    
    if (data.authenticated) {
      log(`✅ Currently authenticated as: ${data.user.username}`, 'success');
    } else {
      log(`❌ Not authenticated: ${data.message}`, 'error');
      if (data.receivedCookies) {
        log(`Cookies received by server: "${data.receivedCookies}"`, 'info');
      }
    }
  } catch (error) {
    resultDiv.textContent = `Error: ${error.message}`;
    log(`Auth check failed: ${error.message}`, 'error');
  }
}

async function startOAuthTest() {
  log('Starting GitHub OAuth test flow...', 'info');
  const resultDiv = document.getElementById('oauth-result');
  
  try {
    // Get GitHub client ID
    const response = await fetch('/.netlify/functions/get-github-client-id');
    const data = await response.json();
    
    if (data.clientId) {
      const redirectUri = encodeURIComponent(window.location.origin + '/.netlify/functions/auth-callback');
      const state = encodeURIComponent('/test-auth-debug.html'); // Return to this page
      
      const githubAuthUrl = `https://github.com/login/oauth/authorize?` +
        `client_id=${data.clientId}&` +
        `redirect_uri=${redirectUri}&` +
        `scope=read:user&` +
        `state=${state}`;
      
      resultDiv.textContent = `Redirecting to GitHub OAuth...\nURL: ${githubAuthUrl}`;
      log('🚀 Redirecting to GitHub OAuth...', 'info');
      log(`OAuth URL: ${githubAuthUrl}`, 'info');
      
      // Redirect after a short delay to show the URL
      setTimeout(() => {
        window.location.href = githubAuthUrl;
      }, 2000);
    } else {
      resultDiv.textContent = 'Error: GitHub OAuth not configured';
      log('❌ GitHub OAuth not configured', 'error');
    }
  } catch (error) {
    resultDiv.textContent = `Error: ${error.message}`;
    log(`OAuth test failed: ${error.message}`, 'error');
  }
}

function inspectCookies() {
  log('Inspecting current browser cookies...', 'info');
  const resultDiv = document.getElementById('cookie-result');
  
  const cookies = document.cookie;
  const cookieArray = cookies.split(';').map(c => c.trim()).filter(c => c.length > 0);
  
  let cookieInfo = `All cookies (${cookieArray.length}):\n`;
  cookieArray.forEach((cookie, index) => {
    cookieInfo += `${index + 1}. ${cookie}\n`;
  });
  
  // Look specifically for admin_session
  const adminSession = cookieArray.find(c => c.startsWith('admin_session='));
  if (adminSession) {
    cookieInfo += `\n🔍 Found admin_session cookie!\n`;
    cookieInfo += `Value: ${adminSession}\n`;
    
    // Try to decode it
    try {
      const tokenValue = adminSession.split('=')[1];
      const decoded = atob(tokenValue);
      cookieInfo += `Decoded: ${decoded}\n`;
      log(`✅ Found admin_session cookie: ${decoded}`, 'success');
    } catch (e) {
      cookieInfo += `Failed to decode: ${e.message}\n`;
      log(`⚠️ Found admin_session but couldn't decode: ${e.message}`, 'warn');
    }
  } else {
    cookieInfo += `\n❌ No admin_session cookie found\n`;
    log('❌ No admin_session cookie found in browser', 'error');
  }
  
  resultDiv.textContent = cookieInfo;
}

async function clearSession() {
  log('Clearing all session data...', 'info');
  const resultDiv = document.getElementById('clear-result');
  
  try {
    // Call logout function
    await fetch('/.netlify/functions/logout', {
      method: 'POST',
      credentials: 'include'
    });
    
    // Clear all cookies manually
    document.cookie.split(";").forEach(function(c) { 
      document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    resultDiv.textContent = 'Session cleared successfully';
    log('✅ Session and cookies cleared', 'success');
    
    // Re-check auth status
    setTimeout(checkCurrentAuth, 1000);
  } catch (error) {
    resultDiv.textContent = `Error: ${error.message}`;
    log(`Session clear failed: ${error.message}`, 'error');
  }
}

// Auto-run initial checks
document.addEventListener('DOMContentLoaded', () => {
  log('🚀 Authentication debug page loaded', 'info');
  log('Running initial checks...', 'info');
  
  setTimeout(() => {
    checkEnvironment();
    setTimeout(() => {
      checkCurrentAuth();
      setTimeout(() => {
        inspectCookies();
      }, 1000);
    }, 1000);
  }, 500);
});

// Debug cookies function
async function debugCookies() {
  const statusDiv = document.getElementById('cookie-status');
  
  // Show current browser cookies
  const allCookies = document.cookie;
  console.log('All browser cookies:', allCookies);
  
  // Test what the server sees
  try {
    const response = await fetch('/.netlify/functions/debug-cookies');
    const data = await response.json();
    
    statusDiv.innerHTML = `
      <h4>🍪 Browser Cookies:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${allCookies || '(no cookies)'}</pre>
      
      <h4>🖥️ Server Sees:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(data, null, 2)}</pre>
    `;
  } catch (error) {
    statusDiv.innerHTML = `
      <h4>🍪 Browser Cookies:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${allCookies || '(no cookies)'}</pre>
      
      <h4>❌ Server Error:</h4>
      <pre style="background: #ffeeee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${error.message}</pre>
    `;
  }
}

// Check if we just came back from OAuth
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('oauth') === 'complete') {
  log('🔄 Detected OAuth return - checking authentication...', 'info');
  setTimeout(() => {
    checkCurrentAuth();
    inspectCookies();
    debugCookies(); // Also run cookie debug
  }, 1000);
}
</script>
</body>
</html>
