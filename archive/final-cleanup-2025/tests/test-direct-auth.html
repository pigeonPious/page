<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß Direct Authentication Fix</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="menu-bar">
  <div class="menu-bar-inner">
    <div class="menu-star">*</div>
    <div class="menu-item"><div class="label" data-menu>File</div><div class="menu-dropdown"><a class="menu-entry" href="index.html">Back to Blog</a></div></div>
  </div>
</div>

<div style="padding: 40px; max-width: 900px; margin: 0 auto; font-family: monospace;">
  <h1>üîß Direct Authentication Fix</h1>
  
  <div style="background: #ffeeee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #ff4444;">
    <h2>‚ö†Ô∏è Quick Fix Approach</h2>
    <p>Since the Netlify dev server is having issues, let's test the authentication directly using the production endpoints.</p>
  </div>

  <div style="background: #eeffee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #44ff44;">
    <h2>üßπ Step 1: Clear Browser Data</h2>
    <button onclick="clearAll()" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      üßπ Clear All Auth Data
    </button>
    <div id="clear-status" style="margin-top: 10px; font-style: italic;"></div>
  </div>

  <div style="background: #fff0ee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #ff8844;">
    <h2>üöÄ Step 2: Test Production Auth</h2>
    <p>Let's test the authentication using your live site:</p>
    <button onclick="testProdAuth()" style="padding: 10px 20px; background: #44aa44; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      üöÄ Test Production Authentication
    </button>
    <div id="prod-test-result" style="margin-top: 15px;"></div>
  </div>

  <div style="background: #f0f8ff; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #4488ff;">
    <h2>üîó Step 3: Manual OAuth (if needed)</h2>
    <p>If production auth doesn't work, try manual OAuth:</p>
    <a href="https://piouspigeon.com/.netlify/functions/auth-start" target="_blank" style="display: inline-block; padding: 10px 20px; background: #4488ff; color: white; text-decoration: none; border-radius: 3px; font-size: 16px;">
      üîó Manual OAuth Login
    </a>
    <p style="margin-top: 10px; font-size: 14px; color: #666;">This will open in a new tab. After logging in, come back here and test posting.</p>
  </div>

  <div style="background: #f8f8f8; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h2>‚úÖ Step 4: Test Local Posting</h2>
    <p>After authentication, test posting locally:</p>
    <button onclick="testLocalPost()" id="test-local-btn" style="padding: 10px 20px; background: #888; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      ‚úÖ Test Local Post
    </button>
    <div id="local-test-result" style="margin-top: 15px;"></div>
  </div>

  <div style="background: #f8f8f8; padding: 20px; border-radius: 5px;">
    <h2>üìù Debug Log</h2>
    <div id="debug-log" style="background: black; color: #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; height: 300px; overflow-y: auto; border-radius: 3px;"></div>
  </div>
</div>

<script>
function log(message, type = 'info') {
  const logDiv = document.getElementById('debug-log');
  const timestamp = new Date().toLocaleTimeString();
  const colors = {
    info: '#00ff00',
    warn: '#ffaa00', 
    error: '#ff4444',
    success: '#44ff44'
  };
  
  const logEntry = document.createElement('div');
  logEntry.style.color = colors[type] || '#00ff00';
  logEntry.style.marginBottom = '5px';
  logEntry.innerHTML = `[${timestamp}] ${message}`;
  
  logDiv.appendChild(logEntry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  console.log(`[AUTH-FIX] ${message}`);
}

function clearAll() {
  const statusDiv = document.getElementById('clear-status');
  statusDiv.innerHTML = 'Clearing...';
  
  log('üßπ Clearing all authentication data...', 'info');
  
  // Clear localStorage
  const localKeys = Object.keys(localStorage);
  localKeys.forEach(key => {
    localStorage.removeItem(key);
    log(`Cleared localStorage: ${key}`, 'info');
  });
  
  // Clear sessionStorage
  const sessionKeys = Object.keys(sessionStorage);
  sessionKeys.forEach(key => {
    sessionStorage.removeItem(key);
    log(`Cleared sessionStorage: ${key}`, 'info');
  });
  
  // Clear all cookies
  const cookies = document.cookie.split(';');
  cookies.forEach(cookie => {
    const [name] = cookie.split('=');
    const cookieName = name.trim();
    if (cookieName) {
      document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
      log(`Cleared cookie: ${cookieName}`, 'info');
    }
  });
  
  statusDiv.innerHTML = '‚úÖ All authentication data cleared';
  log('‚úÖ Authentication cleanup complete', 'success');
}

async function testProdAuth() {
  const resultDiv = document.getElementById('prod-test-result');
  log('üöÄ Testing production authentication...', 'info');
  
  resultDiv.innerHTML = 'Testing production auth endpoints...';
  
  try {
    // Test auth-check on production
    log('Testing production auth-check endpoint...', 'info');
    const authResponse = await fetch('https://piouspigeon.com/.netlify/functions/auth-check', {
      credentials: 'include'
    });
    const authData = await authResponse.json();
    
    log(`Production auth response: ${JSON.stringify(authData)}`, authData.authenticated ? 'success' : 'warn');
    
    if (authData.authenticated) {
      resultDiv.innerHTML = `
        <div style="color: green; font-weight: bold;">‚úÖ AUTHENTICATED!</div>
        <pre style="background: #eeffee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(authData, null, 2)}</pre>
        <p style="color: green;">You're authenticated! The local post button should now work.</p>
      `;
      
      // Enable local test button
      document.getElementById('test-local-btn').style.background = '#44aa44';
      
    } else {
      resultDiv.innerHTML = `
        <div style="color: orange; font-weight: bold;">‚ö†Ô∏è NOT AUTHENTICATED</div>
        <pre style="background: #fff0ee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(authData, null, 2)}</pre>
        <p style="color: orange;">You need to authenticate. Try the manual OAuth login below.</p>
      `;
    }
    
  } catch (error) {
    log(`‚ùå Error testing production auth: ${error.message}`, 'error');
    resultDiv.innerHTML = `
      <div style="color: red; font-weight: bold;">‚ùå ERROR</div>
      <pre style="background: #ffeeee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${error.message}</pre>
      <p style="color: red;">Error connecting to production. Try the manual OAuth login.</p>
    `;
  }
}

async function testLocalPost() {
  const resultDiv = document.getElementById('local-test-result');
  log('‚úÖ Testing local post functionality...', 'info');
  
  resultDiv.innerHTML = 'Testing local post...';
  
  try {
    const testPostData = {
      title: 'Test Post ' + Date.now(),
      content: 'This is a test post to verify authentication is working locally.',
      category: 'test',
      slug: 'test-post-' + Date.now()
    };
    
    log(`Sending test post to production: ${JSON.stringify(testPostData)}`, 'info');
    
    // Test against production since local Netlify functions aren't working
    const response = await fetch('https://piouspigeon.com/.netlify/functions/save-post', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify(testPostData)
    });
    
    const result = await response.json();
    log(`Post response (${response.status}): ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');
    
    if (response.ok) {
      resultDiv.innerHTML = `
        <div style="color: green; font-weight: bold;">‚úÖ SUCCESS!</div>
        <pre style="background: #eeffee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(result, null, 2)}</pre>
        <p style="color: green;">üéâ Posting works! Now you can use your local blog editor normally.</p>
        <p><a href="index.html" style="color: green;">‚Üê Go back to your blog</a></p>
      `;
    } else {
      resultDiv.innerHTML = `
        <div style="color: red; font-weight: bold;">‚ùå FAILED (${response.status})</div>
        <pre style="background: #ffeeee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(result, null, 2)}</pre>
        <p style="color: red;">Still not working. Try the manual OAuth login above.</p>
      `;
    }
    
  } catch (error) {
    log(`‚ùå Error testing post: ${error.message}`, 'error');
    resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
  }
}

// Auto-run on page load
document.addEventListener('DOMContentLoaded', () => {
  log('üîß Direct Authentication Fix page loaded', 'info');
  log('üí° This page uses your production endpoints to test authentication', 'info');
});
</script>

</body>
</html>
