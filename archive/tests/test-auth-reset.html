<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”§ Authentication Reset & Test</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="menu-bar">
  <div class="menu-bar-inner">
    <div class="menu-star">*</div>
    <div class="menu-item"><div class="label" data-menu>File</div><div class="menu-dropdown"><a class="menu-entry" href="index.html">Back to Blog</a></div></div>
  </div>
</div>

<div style="padding: 40px; max-width: 900px; margin: 0 auto; font-family: monospace;">
  <h1>ğŸ”§ Authentication Reset & Test</h1>
  
  <div style="background: #ffeeee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #ff4444;">
    <h2>âš ï¸ Problem Diagnosis</h2>
    <p>You're seeing "âœ… Logged In" but getting 500 errors when posting. This usually means:</p>
    <ul>
      <li>The UI thinks you're logged in (localStorage state)</li>
      <li>But the server doesn't have valid authentication cookies</li>
      <li>The OAuth flow wasn't completed properly</li>
    </ul>
  </div>

  <div style="background: #eeffee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #44ff44;">
    <h2>ğŸ§¹ Step 1: Clear Everything</h2>
    <p>First, let's clear all cached auth data and start fresh:</p>
    <button onclick="clearAll()" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      ğŸ§¹ Clear All Auth Data
    </button>
    <div id="clear-status" style="margin-top: 10px; font-style: italic;"></div>
  </div>

  <div style="background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h2>ğŸ” Step 2: Check Current State</h2>
    <button onclick="checkState()" style="padding: 10px 20px; background: #4444ff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      ğŸ” Check Current State
    </button>
    <div id="state-result" style="margin-top: 15px;"></div>
  </div>

  <div style="background: #fff0ee; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #ff8844;">
    <h2>ğŸš€ Step 3: Fresh OAuth Login</h2>
    <p>Now perform a fresh GitHub OAuth login:</p>
    <button onclick="startFreshLogin()" style="padding: 10px 20px; background: #44aa44; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 16px;">
      ğŸš€ Start Fresh OAuth Login
    </button>
    <div id="login-status" style="margin-top: 10px; font-style: italic;"></div>
  </div>

  <div style="background: #f0f8ff; padding: 20px; border-radius: 5px; margin-bottom: 30px; border-left: 5px solid #4488ff;">
    <h2>âœ… Step 4: Test Posting</h2>
    <p>After completing OAuth, test if posting works:</p>
    <button onclick="testPost()" id="test-post-btn" disabled style="padding: 10px 20px; background: #888; color: white; border: none; border-radius: 3px; cursor: not-allowed; font-size: 16px;">
      âœ… Test Post Function
    </button>
    <div id="post-test-result" style="margin-top: 15px;"></div>
  </div>

  <div style="background: #f8f8f8; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <h2>ğŸ“ Debug Log</h2>
    <div id="debug-log" style="background: black; color: #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; height: 300px; overflow-y: auto; border-radius: 3px;"></div>
  </div>
</div>

<script>
function log(message, type = 'info') {
  const logDiv = document.getElementById('debug-log');
  const timestamp = new Date().toLocaleTimeString();
  const colors = {
    info: '#00ff00',
    warn: '#ffaa00', 
    error: '#ff4444',
    success: '#44ff44'
  };
  
  const logEntry = document.createElement('div');
  logEntry.style.color = colors[type] || '#00ff00';
  logEntry.style.marginBottom = '5px';
  logEntry.innerHTML = `[${timestamp}] ${message}`;
  
  logDiv.appendChild(logEntry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  console.log(`[AUTH-DEBUG] ${message}`);
}

function clearAll() {
  const statusDiv = document.getElementById('clear-status');
  statusDiv.innerHTML = 'Clearing...';
  
  log('ğŸ§¹ Starting auth data cleanup...', 'info');
  
  // Clear localStorage
  const localKeys = Object.keys(localStorage);
  localKeys.forEach(key => {
    if (key.includes('auth') || key.includes('login') || key.includes('user')) {
      localStorage.removeItem(key);
      log(`Removed localStorage: ${key}`, 'info');
    }
  });
  
  // Clear sessionStorage
  const sessionKeys = Object.keys(sessionStorage);
  sessionKeys.forEach(key => {
    if (key.includes('auth') || key.includes('login') || key.includes('user')) {
      sessionStorage.removeItem(key);
      log(`Removed sessionStorage: ${key}`, 'info');
    }
  });
  
  // Clear cookies by setting them to expire
  const cookies = document.cookie.split(';');
  cookies.forEach(cookie => {
    const [name] = cookie.split('=');
    if (name.trim().includes('auth') || name.trim().includes('admin') || name.trim().includes('session')) {
      document.cookie = `${name.trim()}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
      log(`Cleared cookie: ${name.trim()}`, 'info');
    }
  });
  
  statusDiv.innerHTML = 'âœ… Cleared all auth data';
  log('âœ… Auth cleanup complete', 'success');
  
  // Enable state check
  setTimeout(() => {
    statusDiv.innerHTML = 'âœ… Cleared all auth data - Now check state';
  }, 1000);
}

async function checkState() {
  const resultDiv = document.getElementById('state-result');
  log('ğŸ” Checking current authentication state...', 'info');
  
  resultDiv.innerHTML = 'Checking...';
  
  try {
    // Check what cookies exist
    const allCookies = document.cookie;
    log(`Browser cookies: ${allCookies || '(none)'}`, 'info');
    
    // Check server state via debug endpoint  
    const debugResponse = await fetch('/.netlify/functions/debug-cookies');
    const debugData = await debugResponse.json();
    log(`Server cookie data: ${JSON.stringify(debugData, null, 2)}`, 'info');
    
    // Check auth-check endpoint
    const authResponse = await fetch('/.netlify/functions/auth-check');
    const authData = await authResponse.json();
    log(`Auth check result: ${JSON.stringify(authData, null, 2)}`, 'info');
    
    resultDiv.innerHTML = `
      <h4>ğŸª Browser Cookies:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${allCookies || '(no cookies)'}</pre>
      
      <h4>ğŸ–¥ï¸ Server Debug:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(debugData, null, 2)}</pre>
      
      <h4>ğŸ” Auth Check:</h4>
      <pre style="background: white; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(authData, null, 2)}</pre>
    `;
    
    if (authData.authenticated) {
      log('âœ… Authentication appears valid - enabling post test', 'success');
      document.getElementById('test-post-btn').disabled = false;
      document.getElementById('test-post-btn').style.background = '#44aa44';
      document.getElementById('test-post-btn').style.cursor = 'pointer';
    } else {
      log('âŒ Not authenticated - need OAuth login', 'warn');
    }
    
  } catch (error) {
    log(`âŒ Error checking state: ${error.message}`, 'error');
    resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
  }
}

function startFreshLogin() {
  const statusDiv = document.getElementById('login-status');
  log('ğŸš€ Starting fresh OAuth login flow...', 'info');
  statusDiv.innerHTML = 'Redirecting to GitHub OAuth...';
  
  // Force a fresh OAuth by adding timestamp
  const oauthUrl = `/.netlify/functions/auth-start?fresh=${Date.now()}`;
  log(`Redirecting to: ${oauthUrl}`, 'info');
  
  // Redirect to OAuth
  window.location.href = oauthUrl;
}

async function testPost() {
  const resultDiv = document.getElementById('post-test-result');
  log('âœ… Testing post functionality...', 'info');
  
  resultDiv.innerHTML = 'Testing...';
  
  try {
    const testPostData = {
      title: 'Test Post ' + Date.now(),
      content: 'This is a test post to verify authentication is working.',
      category: 'test',
      slug: 'test-post-' + Date.now()
    };
    
    log(`Sending test post: ${JSON.stringify(testPostData)}`, 'info');
    
    const response = await fetch('/.netlify/functions/save-post', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(testPostData)
    });
    
    const result = await response.json();
    log(`Post response (${response.status}): ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');
    
    if (response.ok) {
      resultDiv.innerHTML = `
        <div style="color: green; font-weight: bold;">âœ… SUCCESS!</div>
        <pre style="background: #eeffee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(result, null, 2)}</pre>
        <p style="color: green;">ğŸ‰ Your authentication is working! You can now use the blog normally.</p>
      `;
    } else {
      resultDiv.innerHTML = `
        <div style="color: red; font-weight: bold;">âŒ FAILED (${response.status})</div>
        <pre style="background: #ffeeee; padding: 10px; margin: 5px 0; overflow-x: auto; font-size: 11px;">${JSON.stringify(result, null, 2)}</pre>
        <p style="color: red;">The authentication is still not working properly.</p>
      `;
    }
    
  } catch (error) {
    log(`âŒ Error testing post: ${error.message}`, 'error');
    resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
  }
}

// Auto-check state on page load
document.addEventListener('DOMContentLoaded', () => {
  log('ğŸ”§ Authentication Reset & Test page loaded', 'info');
  
  // Check if we just returned from OAuth
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('oauth') === 'complete' || urlParams.get('fresh')) {
    log('ğŸ”„ Detected return from OAuth - checking state...', 'success');
    setTimeout(() => {
      checkState();
    }, 1000);
  }
});
</script>

</body>
</html>
