<!DOCTYPE html>
<html>
<head>
    <title>Note Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
        }
        
        #editor {
            border: 1px solid #ddd;
            padding: 20px;
            min-height: 200px;
            background: white;
            margin-bottom: 20px;
        }
        
        .note-link {
            background-color: rgba(0, 123, 255, 0.15) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            cursor: help !important;
            border-bottom: 2px dotted #007bff !important;
            position: relative !important;
            text-decoration: none !important;
            display: inline !important;
        }
        
        .note-link:hover {
            background-color: rgba(0, 123, 255, 0.25) !important;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Note Functionality Test</h1>
    
    <button onclick="makeNote()">üìù Make Note</button>
    
    <div id="editor" contenteditable="true">
        <p>This is some test content. <span class="note-link" data-note="This is a pre-existing note that should work" style="background-color: rgba(0, 123, 255, 0.15); padding: 2px 4px; border-radius: 3px; cursor: help; border-bottom: 2px dotted #007bff;">This text has a note</span> that you can hover over.</p>
        <p>Select any text below and click "Make Note" to add a new note.</p>
        <p>Here is some text you can select to test the note creation functionality.</p>
    </div>
    
    <div id="modal">
        <div class="modal-content">
            <h3>Add Note</h3>
            <p>Selected text: <strong id="selectedText"></strong></p>
            <input type="text" id="noteText" placeholder="Enter note text here..." />
            <br>
            <button onclick="addNote()">Add Note</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>
    
    <script>
        let currentSelection = null;
        
        // Set up hover tooltips
        function setupHoverNotes() {
            console.log('Setting up hover notes...');
            
            // Create tooltip element
            const tip = document.createElement('div');
            tip.id = 'tooltip';
            tip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 14px;
                max-width: 250px;
                word-wrap: break-word;
                z-index: 1000;
                display: none;
                pointer-events: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(tip);
            
            const editor = document.getElementById('editor');
            
            function placeTip(x, y) {
                const pad = 10;
                const rect = tip.getBoundingClientRect();
                tip.style.left = Math.min(window.innerWidth - rect.width - pad, x + 14) + 'px';
                tip.style.top = Math.min(window.innerHeight - rect.height - pad, y + 18) + 'px';
            }
            
            // Use event delegation for dynamically created notes
            editor.addEventListener('mouseover', (e) => {
                console.log('Mouseover:', e.target);
                
                let noteElement = e.target;
                while (noteElement && noteElement !== editor) {
                    if (noteElement.classList && noteElement.classList.contains('note-link')) {
                        const noteText = noteElement.getAttribute('data-note');
                        console.log('Found note:', noteText);
                        if (noteText) {
                            tip.textContent = noteText;
                            tip.style.display = 'block';
                            placeTip(e.clientX, e.clientY);
                        }
                        break;
                    }
                    noteElement = noteElement.parentNode;
                }
            });
            
            editor.addEventListener('mousemove', (e) => {
                if (tip.style.display === 'block') {
                    placeTip(e.clientX, e.clientY);
                }
            });
            
            editor.addEventListener('mouseout', (e) => {
                // Check if we're still over a note
                let stillOverNote = false;
                if (e.relatedTarget) {
                    let element = e.relatedTarget;
                    while (element && element !== editor) {
                        if (element.classList && element.classList.contains('note-link')) {
                            stillOverNote = true;
                            break;
                        }
                        element = element.parentNode;
                    }
                }
                
                if (!stillOverNote) {
                    tip.style.display = 'none';
                }
            });
        }
        
        function makeNote() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alert('Please select some text first!');
                return;
            }
            
            // Store the current selection
            currentSelection = {
                text: selectedText,
                range: selection.getRangeAt(0).cloneRange()
            };
            
            document.getElementById('selectedText').textContent = selectedText;
            document.getElementById('noteText').value = '';
            document.getElementById('modal').style.display = 'block';
            
            setTimeout(() => document.getElementById('noteText').focus(), 100);
        }
        
        function addNote() {
            const noteText = document.getElementById('noteText').value.trim();
            
            if (!noteText) {
                alert('Please enter note text!');
                return;
            }
            
            if (!currentSelection) {
                alert('No text selected!');
                return;
            }
            
            // Create note link
            const noteLink = document.createElement('span');
            noteLink.className = 'note-link';
            noteLink.setAttribute('data-note', noteText);
            noteLink.textContent = currentSelection.text;
            
            // Apply styling
            noteLink.style.cssText = `
                background-color: rgba(0, 123, 255, 0.15) !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
                cursor: help !important;
                border-bottom: 2px dotted #007bff !important;
                position: relative !important;
                text-decoration: none !important;
                display: inline !important;
            `;
            
            console.log('Created note link:', noteLink);
            
            // Replace selected text with note link
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentSelection.range);
            
            currentSelection.range.deleteContents();
            currentSelection.range.insertNode(noteLink);
            
            // Clear selection
            selection.removeAllRanges();
            
            // Focus back on editor
            document.getElementById('editor').focus();
            
            closeModal();
            
            console.log('Note added successfully!');
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentSelection = null;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, setting up hover notes...');
            setupHoverNotes();
        });
        
        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });
        
        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                makeNote();
            }
        });
    </script>
</body>
</html>
