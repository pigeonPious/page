<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Authentication & Modal Fixes</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="menu-bar">
  <div class="menu-bar-inner">
    <div class="menu-star">*</div>
    <div class="menu-item"><div class="label" data-menu>File</div><div class="menu-dropdown"><a class="menu-entry" href="index.html">Back to Blog</a></div></div>
  </div>
</div>

<div style="padding: 40px; max-width: 800px; margin: 0 auto;">
  <h1>üß™ Authentication & Modal Fix Tests</h1>
  
  <div style="margin-bottom: 30px;">
    <h2>1. Authentication Status</h2>
    <p id="auth-status">Checking authentication...</p>
    <button onclick="checkAuth()" style="padding: 10px 20px; margin: 10px 0;">Check Auth Status</button>
    <a href="/login.html" style="display: inline-block; padding: 10px 20px; background: #24292e; color: white; text-decoration: none; border-radius: 5px;">Go to Login</a>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>2. Modal Positioning Test</h2>
    <p>Test if the modal appears centered and visible:</p>
    <button onclick="testModal()" style="padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer;">Test Modal Display</button>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h2>3. Post Button Simulation</h2>
    <p>Simulate the Post button functionality:</p>
    <textarea id="test-content" placeholder="Enter test content..." style="width: 100%; height: 100px; margin: 10px 0; padding: 10px;"></textarea>
    <button onclick="simulatePost()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Simulate Post</button>
  </div>
  
  <div id="test-log" style="background: #f5f5f5; padding: 20px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
    Test log will appear here...
  </div>
</div>

<!-- Test Modal -->
<div id="messageModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3 id="messageTitle">Test Modal</h3>
    <p id="messageText">This is a test modal to verify positioning fixes.</p>
    <div class="modal-buttons">
      <button id="closeMessage" class="add-btn">Close</button>
    </div>
  </div>
</div>

<script src="script.js"></script>
<script>
// Test functions
function log(message) {
  const testLog = document.getElementById('test-log');
  const timestamp = new Date().toLocaleTimeString();
  testLog.textContent += `[${timestamp}] ${message}\n`;
  testLog.scrollTop = testLog.scrollHeight;
}

async function checkAuth() {
  log('üîç Checking authentication status...');
  
  try {
    const response = await fetch('/.netlify/functions/auth-check', {
      credentials: 'include'
    });
    
    const data = await response.json();
    const statusElement = document.getElementById('auth-status');
    
    if (data.authenticated) {
      statusElement.innerHTML = `‚úÖ <strong>Authenticated</strong> as ${data.user.username}`;
      statusElement.style.color = '#28a745';
      log(`‚úÖ Authentication successful: ${data.user.username}`);
    } else {
      statusElement.innerHTML = `‚ùå <strong>Not Authenticated</strong>: ${data.message}`;
      statusElement.style.color = '#dc3545';
      log(`‚ùå Authentication failed: ${data.message}`);
    }
  } catch (error) {
    log(`‚ùå Auth check error: ${error.message}`);
    document.getElementById('auth-status').innerHTML = `‚ö†Ô∏è <strong>Connection Error</strong>`;
  }
}

function testModal() {
  log('üé≠ Testing modal display...');
  
  // Use the enhanced showMessage function if available
  if (window.editorManager && window.editorManager.showMessage) {
    log('Using EditorManager.showMessage()');
    window.editorManager.showMessage('Test Success', 'Modal positioning fix is working! The modal should be centered and visible.');
  } else {
    log('Using direct modal manipulation');
    const messageModal = document.getElementById('messageModal');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    
    if (messageModal && messageTitle && messageText) {
      messageTitle.textContent = 'Test Success';
      messageText.textContent = 'Modal positioning fix is working! The modal should be centered and visible.';
      
      // Apply the same fixes as in the updated showMessage function
      messageModal.style.display = 'block';
      messageModal.style.position = 'fixed';
      messageModal.style.zIndex = '9999';
      messageModal.style.left = '50%';
      messageModal.style.top = '50%';
      messageModal.style.transform = 'translate(-50%, -50%)';
      messageModal.style.width = 'auto';
      messageModal.style.height = 'auto';
      messageModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
      
      const modalContent = messageModal.querySelector('.modal-content');
      if (modalContent) {
        modalContent.style.margin = '0';
        modalContent.style.position = 'relative';
        modalContent.style.transform = 'none';
      }
      
      log('‚úÖ Modal should now be visible and centered');
    } else {
      log('‚ùå Modal elements not found');
      alert('Test Success: Modal positioning fix is working!');
    }
  }
}

async function simulatePost() {
  const content = document.getElementById('test-content').value.trim();
  
  if (!content) {
    log('‚ùå Please enter some test content first');
    return;
  }
  
  log('üìù Simulating post submission...');
  
  try {
    // Simulate the post data structure
    const postData = {
      title: 'Test Post',
      content: content,
      date: new Date().toISOString().split('T')[0],
      category: 'test',
      slug: 'test-post-' + Date.now()
    };
    
    log(`üì§ Sending post data: ${JSON.stringify(postData, null, 2)}`);
    
    const response = await fetch('/.netlify/functions/save-post', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include', // This is the key fix for authentication
      body: JSON.stringify(postData)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      log('‚úÖ Post simulation successful!');
      testModal(); // Show success modal
    } else {
      log(`‚ùå Post simulation failed: ${result.error || 'Unknown error'}`);
      if (response.status === 401) {
        log('üîê Authentication required - please log in first');
      }
    }
  } catch (error) {
    log(`‚ùå Network error during post simulation: ${error.message}`);
  }
}

// Set up modal close handler
document.addEventListener('DOMContentLoaded', () => {
  const closeMessageBtn = document.getElementById('closeMessage');
  const messageModal = document.getElementById('messageModal');
  
  if (closeMessageBtn) {
    closeMessageBtn.addEventListener('click', () => {
      messageModal.style.display = 'none';
    });
  }
  
  // Close modal when clicking outside
  if (messageModal) {
    messageModal.addEventListener('click', (e) => {
      if (e.target === messageModal) {
        messageModal.style.display = 'none';
      }
    });
  }
  
  // Initialize EditorManager if script.js loaded it
  setTimeout(() => {
    if (window.EditorManager && !window.editorManager) {
      window.editorManager = new window.EditorManager();
      log('üìù EditorManager initialized for testing');
    }
  }, 1000);
  
  // Auto-check auth on page load
  checkAuth();
  
  log('üöÄ Test page loaded - ready for testing!');
});
</script>
</body>
</html>
