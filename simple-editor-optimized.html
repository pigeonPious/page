<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔧 Simple Local Editor</title>
  <link rel="stylesheet" href="simple-editor.css">
</head>
<body class="dark-mode">

<!-- Menu Bar -->
<div class="menu-bar">
  <div class="menu-bar-inner">
    <div class="menu-star">*</div>
    <div class="menu-item"><div class="label" data-menu>File</div>
      <div class="menu-dropdown">
        <div class="menu-entry" onclick="editor.newDocument()">New</div>
        <a class="menu-entry" href="index.html">Back to Blog</a>
        <div class="menu-entry" onclick="editor.saveDraft()">Save Draft</div>
        <div class="menu-entry" onclick="editor.showDraftsList()">Load Draft</div>
        <div class="menu-entry" onclick="editor.exportPost()">Export Post</div>
        <div class="menu-entry" onclick="editor.manageDrafts()">Manage Drafts</div>
      </div>
    </div>
    <div class="menu-item"><div class="label" data-menu>Edit</div>
      <div class="menu-dropdown">
        <div class="menu-entry" onclick="editor.makeNote()">Make Note</div>
        <div class="menu-entry" onclick="editor.toggleRawMode()">Toggle Mode</div>
      </div>
    </div>
    <div class="menu-item"><div class="label" data-menu>View</div>
      <div class="menu-dropdown">
        <div class="menu-entry" data-mode="dark">Dark</div>
        <div class="menu-entry" data-mode="light">Light</div>
        <div class="menu-entry" onclick="editor.toggleRawMode()" id="view-mode-toggle">Visual Mode</div>
      </div>
    </div>
    <div class="menu-item"><div class="label" data-menu>Connect</div>
      <div class="menu-dropdown">
        <div class="menu-entry">Status: <span id="local-status">📝 Local Mode</span></div>
        <div class="menu-entry" id="github-setup">
          <span onclick="editor.setupGitHub()">Setup GitHub</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Editor -->
<div class="frame">
  <main class="center-content">
    <div class="editor-header">
      <input type="text" id="postTitle" class="title-input" placeholder="Post Title">
    </div>
    
    <div class="editor-tools">
      <div class="editor-tools-left">
        <span id="category-btn">📁 <span id="current-category">General</span></span>
      </div>
      <div class="editor-tools-right">
        <span id="export-btn">📤 Export</span>
        <span id="publish-btn" style="display: none;">🚀 Publish</span>
      </div>
    </div>

    <div class="editor-main">
      <div id="visualEditor" class="visual-editor" contenteditable="true" 
           data-placeholder="Write your post content here using Markdown...

Select text and press Ctrl+M to add notes.">
      </div>
    </div>
  </main>
</div>

<!-- Category Selection Modal -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <h3>📁 Select Category</h3>
    <div class="category-options">
      <div class="category-option" data-category="general">General</div>
      <div class="category-option" data-category="tech">Tech</div>
      <div class="category-option" data-category="personal">Personal</div>
      <div class="category-option" data-category="thoughts">Thoughts</div>
    </div>
    <div class="modal-buttons">
      <button onclick="editor.closeModal('categoryModal')" class="btn">Cancel</button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal">
  <div class="modal-content">
    <h3>📤 Export Post</h3>
    <p>Your post is ready! Copy the JSON below and save it as <strong><span id="export-filename"></span></strong> in your GitHub repository.</p>
    <p id="publish-mode" style="font-style: italic; opacity: 0.8;"></p>
    
    <textarea id="exportContent" readonly style="width: 100%; height: 300px; font-family: monospace; font-size: 12px;"></textarea>
    
    <div class="modal-buttons">
      <button onclick="editor.copyExport()" class="btn primary">📋 Copy JSON</button>
      <button onclick="editor.downloadExport()" class="btn">💾 Download File</button>
      <button onclick="editor.closeModal('exportModal')" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- GitHub Setup Modal -->
<div id="githubModal" class="modal">
  <div class="modal-content">
    <h3>🔧 Setup GitHub Publishing</h3>
    <p>Enter your GitHub details to publish posts directly:</p>
    
    <div style="margin: 15px 0;">
      <label><strong>GitHub Personal Access Token:</strong></label>
      <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
      <small style="color: #666;">Create at: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a> (needs repo scope)</small>
    </div>
    
    <div style="margin: 15px 0;">
      <label><strong>Repository:</strong></label>
      <input type="text" id="github-repo" placeholder="username/repository-name">
    </div>
    
    <div style="margin: 15px 0;">
      <label><strong>Branch:</strong></label>
      <input type="text" id="github-branch" value="main">
    </div>
    
    <div class="modal-buttons">
      <button onclick="editor.saveGitHubConfig()" class="btn primary">💾 Save & Test</button>
      <button onclick="editor.closeModal('githubModal')" class="btn">Cancel</button>
    </div>
  </div>
</div>

<!-- Drafts Modal -->
<div id="draftsModal" class="modal">
  <div class="modal-content">
    <h3>📄 Your Drafts</h3>
    <div id="drafts-list"></div>
    <div class="modal-buttons">
      <button onclick="editor.closeModal('draftsModal')" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Message Modal -->
<div id="messageModal" class="modal">
  <div class="modal-content">
    <h3 id="message-title">📝 Message</h3>
    <p id="message-content"></p>
    <div class="modal-buttons">
      <button onclick="editor.closeModal('messageModal')" class="btn primary">OK</button>
    </div>
  </div>
</div>

<script>
// Simple Editor - Optimized and Clean
const editor = {
  // Core state
  currentCategory: 'general',
  isRawMode: false,
  noteCounter: 1,

  // Initialize editor
  init() {
    this.setupEventListeners();
    this.setupMenus();
    this.setupModalManagement();
    this.checkGitHubConfig();
    console.log('Simple Editor initialized');
  },

  // Event listeners
  setupEventListeners() {
    // Category button
    document.getElementById('category-btn').addEventListener('click', () => this.showModal('categoryModal'));
    
    // Export button
    document.getElementById('export-btn').addEventListener('click', () => this.exportPost());
    
    // Publish button
    document.getElementById('publish-btn').addEventListener('click', () => this.publishPost());
    
    // Category options
    document.querySelectorAll('.category-option').forEach(option => {
      option.addEventListener('click', () => {
        this.currentCategory = option.dataset.category;
        document.getElementById('current-category').textContent = 
          option.textContent;
        this.closeModal('categoryModal');
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'm') {
        e.preventDefault();
        this.makeNote();
      }
      if (e.key === 'Escape') {
        this.closeAllModals();
      }
    });
  },

  // Menu system
  setupMenus() {
    document.querySelectorAll('[data-menu]').forEach(menu => {
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // Close other menus
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item !== menu.parentElement) {
            item.classList.remove('open');
          }
        });
        
        // Toggle current menu
        menu.parentElement.classList.toggle('open');
      });
    });

    // Close menus when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('open');
      });
    });

    // Mode switching
    document.querySelectorAll('[data-mode]').forEach(modeBtn => {
      modeBtn.addEventListener('click', () => {
        const mode = modeBtn.dataset.mode;
        document.body.className = mode === 'dark' ? 'dark-mode' : '';
      });
    });
  },

  // Modal management
  setupModalManagement() {
    // Click outside to close
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          this.closeModal(modal.id);
        }
      });
    });
  },

  showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Force reset all positioning
    modal.style.cssText = '';
    modal.classList.add('show');
    
    console.log(`Showing modal: ${modalId}`);
  },

  closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.classList.remove('show');
    console.log(`Closed modal: ${modalId}`);
  },

  closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.remove('show');
    });
  },

  // Document management
  newDocument() {
    document.getElementById('postTitle').value = '';
    document.getElementById('visualEditor').innerHTML = '';
    this.currentCategory = 'general';
    document.getElementById('current-category').textContent = 'General';
    console.log('New document created');
  },

  // Note functionality
  makeNote() {
    const selection = window.getSelection();
    if (selection.rangeCount === 0) {
      this.showMessage('Select some text first to create a note.');
      return;
    }

    const range = selection.getRangeAt(0);
    const selectedText = range.toString().trim();
    
    if (!selectedText) {
      this.showMessage('Please select some text to create a note.');
      return;
    }

    const note = prompt('Enter your note:');
    if (!note) return;

    // Create note link
    const noteId = `note-${this.noteCounter++}`;
    const noteLink = document.createElement('span');
    noteLink.className = 'note-link';
    noteLink.dataset.noteId = noteId;
    noteLink.dataset.note = note;
    noteLink.title = note;
    noteLink.textContent = selectedText;

    // Replace selection with note link
    range.deleteContents();
    range.insertNode(noteLink);
    
    selection.removeAllRanges();
    console.log(`Created note: ${noteId}`);
  },

  toggleRawMode() {
    this.isRawMode = !this.isRawMode;
    const toggle = document.getElementById('view-mode-toggle');
    toggle.textContent = this.isRawMode ? 'Visual Mode' : 'Raw Mode';
    console.log(`Toggled to ${this.isRawMode ? 'raw' : 'visual'} mode`);
  },

  // Export functionality
  exportPost() {
    const title = document.getElementById('postTitle').value.trim();
    if (!title) {
      this.showMessage('Please enter a title for your post.');
      return;
    }

    const content = document.getElementById('visualEditor').innerHTML;
    if (!content.trim()) {
      this.showMessage('Please write some content for your post.');
      return;
    }

    const post = {
      title,
      content,
      category: this.currentCategory,
      date: new Date().toISOString(),
      id: title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, ''),
      notes: this.extractNotes()
    };

    document.getElementById('exportContent').value = JSON.stringify(post, null, 2);
    document.getElementById('export-filename').textContent = `${post.id}.json`;
    
    this.showModal('exportModal');
  },

  extractNotes() {
    const noteLinks = document.querySelectorAll('.note-link');
    const notes = {};
    noteLinks.forEach(link => {
      notes[link.dataset.noteId] = link.dataset.note;
    });
    return notes;
  },

  copyExport() {
    const content = document.getElementById('exportContent');
    content.select();
    document.execCommand('copy');
    this.showMessage('Exported JSON copied to clipboard!');
  },

  downloadExport() {
    const content = document.getElementById('exportContent').value;
    const filename = document.getElementById('export-filename').textContent;
    
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    this.showMessage('File downloaded successfully!');
  },

  // Draft management
  saveDraft() {
    const title = document.getElementById('postTitle').value.trim() || 'Untitled Draft';
    const content = document.getElementById('visualEditor').innerHTML;
    
    const draft = {
      title,
      content,
      category: this.currentCategory,
      saved: new Date().toISOString()
    };

    const drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
    drafts.push(draft);
    localStorage.setItem('drafts', JSON.stringify(drafts));
    
    this.showMessage(`Draft "${title}" saved successfully!`);
  },

  showDraftsList() {
    const drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
    const list = document.getElementById('drafts-list');
    
    if (drafts.length === 0) {
      list.innerHTML = '<p>No drafts saved yet.</p>';
    } else {
      list.innerHTML = drafts.map((draft, index) => `
        <div style="border: 1px solid var(--border); padding: 10px; margin: 5px 0; border-radius: 3px;">
          <strong>${draft.title}</strong><br>
          <small>Category: ${draft.category} | Saved: ${new Date(draft.saved).toLocaleDateString()}</small><br>
          <button onclick="editor.loadDraft(${index})" class="btn primary" style="margin: 5px 5px 0 0;">Load</button>
          <button onclick="editor.deleteDraft(${index})" class="btn">Delete</button>
        </div>
      `).join('');
    }
    
    this.showModal('draftsModal');
  },

  loadDraft(index) {
    const drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
    const draft = drafts[index];
    
    if (draft) {
      document.getElementById('postTitle').value = draft.title;
      document.getElementById('visualEditor').innerHTML = draft.content;
      this.currentCategory = draft.category;
      document.getElementById('current-category').textContent = 
        draft.category.charAt(0).toUpperCase() + draft.category.slice(1);
      
      this.closeModal('draftsModal');
      this.showMessage('Draft loaded successfully!');
    }
  },

  deleteDraft(index) {
    if (confirm('Are you sure you want to delete this draft?')) {
      const drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
      drafts.splice(index, 1);
      localStorage.setItem('drafts', JSON.stringify(drafts));
      this.showDraftsList(); // Refresh the list
    }
  },

  manageDrafts() {
    this.showDraftsList();
  },

  // GitHub integration
  checkGitHubConfig() {
    const config = this.getGitHubConfig();
    if (config && config.token && config.repo) {
      document.getElementById('github-setup').innerHTML = 
        '<span class="github-connected">✅ GitHub connected</span> ' +
        '<button onclick="editor.setupGitHub()" class="btn" style="margin-left: 10px;">⚙️ Edit</button>';
      document.getElementById('publish-mode').textContent = 'or publish directly to GitHub!';
      document.getElementById('publish-btn').style.display = 'inline-block';
      document.getElementById('export-btn').classList.remove('primary');
    }
  },

  setupGitHub() {
    const config = this.getGitHubConfig() || {};
    document.getElementById('github-token').value = config.token || '';
    document.getElementById('github-repo').value = config.repo || '';
    document.getElementById('github-branch').value = config.branch || 'main';
    
    this.showModal('githubModal');
  },

  saveGitHubConfig() {
    const token = document.getElementById('github-token').value.trim();
    const repo = document.getElementById('github-repo').value.trim();
    const branch = document.getElementById('github-branch').value.trim() || 'main';

    if (!token || !repo) {
      this.showMessage('Please fill in both token and repository fields.');
      return;
    }

    const config = { token, repo, branch };
    localStorage.setItem('githubConfig', JSON.stringify(config));
    
    this.closeModal('githubModal');
    this.checkGitHubConfig();
    this.showMessage('GitHub configuration saved successfully!');
  },

  getGitHubConfig() {
    try {
      return JSON.parse(localStorage.getItem('githubConfig'));
    } catch {
      return null;
    }
  },

  publishPost() {
    this.showMessage('GitHub publishing feature coming soon!');
  },

  // Utility functions
  showMessage(message, title = '📝 Simple Editor') {
    document.getElementById('message-title').textContent = title;
    document.getElementById('message-content').textContent = message;
    this.showModal('messageModal');
  }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  editor.init();
});

// For backwards compatibility
const localEditor = editor;
</script>

</body>
</html>
