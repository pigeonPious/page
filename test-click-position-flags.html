<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Click Position FLAGS Test</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="editor.css">
</head>
<body>

<div class="frame">
  <main class="center-content">
    <div class="editor-main-column">
      <div class="editor-header">
        <input type="text" id="postTitle" class="title-input" placeholder="Click Position Test" value="Click Position FLAGS Test">
      </div>
      
      <div class="editor-main">
        <div id="visualEditor" class="visual-editor" contenteditable="true">
          <h1>Testing Click Position Anchoring</h1>
          <p>This test verifies that FLAGS input anchors to the click position.</p>
          
          <h2>Test Instructions:</h2>
          <ol>
            <li>Click the FLAGS button in the sidebar →</li>
            <li>The Box Style 1 popup should appear near where you clicked</li>
            <li>Try clicking different parts of the FLAGS button</li>
            <li>Popup should follow your click position</li>
          </ol>
          
          <h2>Image Magazine Changes:</h2>
          <ul>
            <li>✅ No more emojis in Image Magazine title</li>
            <li>✅ "Import" button without emoji</li>
            <li>✅ Image filename display without emoji</li>
            <li>✅ Clean, professional appearance</li>
          </ul>
          
          <div style="margin: 20px 0; padding: 15px; border: 2px solid var(--border);">
            <p><strong>Visual Test:</strong> Click the FLAGS button at different positions and watch where the popup appears!</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div class="editor-sidebar">
    <div class="editor-tools-vertical">
      <div class="tool-button" id="keywords-btn">
        FLAGS
        <span class="tool-value" id="current-keywords">general</span>
      </div>
      
      <div class="tool-button" id="images-btn">
        IMAGES
        <span class="tool-value">Manage Images</span>
      </div>
      
      <div class="tool-button" id="test-positioning-btn">
        TEST POSITIONING
      </div>
    </div>
  </div>
</div>

<!-- Box Style 1 Inputs -->
<div id="keywordsInputBox" class="box-style-1 hidden">
  <input type="text" placeholder="e.g. devlog:ProjectName, programming, design" maxlength="200">
</div>

<div id="messageBox" class="box-style-1 message-box hidden">
  <span class="message-text">Message will appear here</span>
</div>

<!-- Image Magazine - Clean version without emojis -->
<div id="imageMagazine" class="box-style-1 image-magazine hidden">
  <div class="image-magazine-header">
    <span class="image-magazine-title">Image Magazine</span>
    <div class="image-magazine-controls">
      <button class="image-magazine-btn" id="import-image-btn">Import</button>
      <button class="image-magazine-btn close-btn" id="close-magazine-btn">×</button>
    </div>
  </div>
  <div class="image-magazine-content">
    <div class="image-gallery" id="imageGallery">
      <div class="no-images-message">
        <p>No images found in repository</p>
        <p><small>Click Import to add images</small></p>
      </div>
    </div>
  </div>
</div>

<script src="shared-taskbar.js"></script>

<script>
// Test editor for click position anchoring
const testEditor = {
  currentKeywords: 'general',

  init() {
    document.getElementById('current-keywords').textContent = this.currentKeywords;
    
    // FLAGS button with click position anchoring
    document.getElementById('keywords-btn').addEventListener('click', (e) => this.showKeywordsInput(e));
    
    // Images button 
    document.getElementById('images-btn').addEventListener('click', () => this.toggleImageMagazine());
    
    // Test positioning button
    document.getElementById('test-positioning-btn').addEventListener('click', (e) => this.testClickPositioning(e));
    
    console.log('Click position test editor initialized');
  },

  showKeywordsInput(clickEvent = null) {
    const options = clickEvent ? { anchorToClick: true, clickEvent } : {};
    this.showBoxInput('keywordsInputBox', (keywords) => {
      if (keywords.trim()) {
        this.currentKeywords = keywords.trim();
        document.getElementById('current-keywords').textContent = this.currentKeywords;
        console.log('Keywords updated at click position:', this.currentKeywords);
        this.showBoxMessage(`✅ FLAGS updated: "${this.currentKeywords}"`);
      }
    }, this.currentKeywords || 'general', options);
  },

  testClickPositioning(clickEvent) {
    this.showBoxMessage(`Click detected at: X=${clickEvent.clientX}, Y=${clickEvent.clientY}`);
    console.log('Click position:', clickEvent.clientX, clickEvent.clientY);
  },

  toggleImageMagazine() {
    const magazine = document.getElementById('imageMagazine');
    if (magazine.classList.contains('hidden')) {
      magazine.classList.remove('hidden');
      magazine.style.left = '200px';
      magazine.style.top = '100px';
      this.showBoxMessage('Image Magazine opened (no emojis!)');
    } else {
      magazine.classList.add('hidden');
      this.showBoxMessage('Image Magazine closed');
    }
  },

  // Box Style 1 Input System with click positioning
  showBoxInput(boxId, onConfirm, initialValue = '', options = {}) {
    const box = document.getElementById(boxId);
    const input = box.querySelector('input');
    
    // Position the box - prioritize click position for non-taskbar inputs
    let x = 100, y = 100;
    
    if (options.anchorToClick && options.clickEvent) {
      // Use click position for FLAGS and other non-taskbar inputs
      x = options.clickEvent.clientX + 10;
      y = options.clickEvent.clientY + 10;
      console.log('Anchoring to click position:', x, y);
    } else {
      // Fallback to stored mouse position
      x = window.lastMouseX || 100;
      y = window.lastMouseY || 100;
    }
    
    // Ensure popup stays within viewport boundaries
    const boxWidth = 300;
    const boxHeight = 40;
    
    if (x + boxWidth > window.innerWidth) {
      x = window.innerWidth - boxWidth - 10;
    }
    if (y + boxHeight > window.innerHeight) {
      y = window.innerHeight - boxHeight - 10;
    }
    if (x < 10) x = 10;
    if (y < 10) y = 10;
    
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.classList.remove('hidden');
    
    input.value = initialValue;
    input.focus();
    input.select();
    
    // Handle Enter and Escape
    const handleKeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = input.value.trim();
        this.hideBoxInput(boxId);
        if (onConfirm) onConfirm(value);
        input.removeEventListener('keydown', handleKeydown);
        document.removeEventListener('click', handleClickOutside);
      } else if (e.key === 'Escape') {
        e.preventDefault();
        this.hideBoxInput(boxId);
        input.removeEventListener('keydown', handleKeydown);
        document.removeEventListener('click', handleClickOutside);
      }
    };
    
    // Handle click outside
    const handleClickOutside = (e) => {
      if (!box.contains(e.target)) {
        this.hideBoxInput(boxId);
        input.removeEventListener('keydown', handleKeydown);
        document.removeEventListener('click', handleClickOutside);
      }
    };
    
    input.addEventListener('keydown', handleKeydown);
    setTimeout(() => {
      document.addEventListener('click', handleClickOutside);
    }, 100);
  },

  hideBoxInput(boxId) {
    const box = document.getElementById(boxId);
    box.classList.add('hidden');
  },

  showBoxMessage(message) {
    const box = document.getElementById('messageBox');
    const textSpan = box.querySelector('.message-text');
    
    textSpan.textContent = message;
    
    let x = window.lastMouseX || (window.innerWidth / 2 - 150);
    let y = window.lastMouseY || (window.innerHeight / 3);
    
    x += 10;
    y += 10;
    
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.classList.remove('hidden');
    
    setTimeout(() => {
      box.classList.add('hidden');
    }, 3000);
  }
};

// Track mouse position
document.addEventListener('mousemove', (e) => {
  window.lastMouseX = e.clientX;
  window.lastMouseY = e.clientY;
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  testEditor.init();
});
</script>

</body>
</html>
