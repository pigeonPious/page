<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Taskbar Fix Test - Build 20250821</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .test-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px;
    }
    .test-panel {
      padding: 15px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .status {
      padding: 5px;
      margin: 3px 0;
      border-radius: 3px;
    }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .test-btn {
      margin: 5px;
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .test-btn:hover { background: #0056b3; }
    .console-area {
      height: 200px;
      overflow-y: auto;
      background: #1a1a1a;
      color: #00ff00;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div class="page-container">
  <main class="main-column">
    <header class="post-header">
      <h1>Final Taskbar Button Fix Test</h1>
      <div class="post-date">Build 20250821 - Complete button functionality verification</div>
    </header>
    
    <div class="test-grid">
      <div class="test-panel">
        <h3>Post Display</h3>
        <div id="post-content">
          <h2 id="post-title">No post loaded</h2>
          <div id="post-date">-</div>
          <div id="post-content-body">Click buttons to load posts</div>
        </div>
      </div>
      
      <div class="test-panel">
        <h3>Manual Tests</h3>
        <p>Direct method calls:</p>
        <button class="test-btn" onclick="testLatestDirect()">Test loadLatestPost() Direct</button>
        <button class="test-btn" onclick="testRandomDirect()">Test loadRandomPost() Direct</button>
        <button class="test-btn" onclick="testMostRecentDirect()">Test loadMostRecentPost() Direct</button>
        
        <p>Button click simulation:</p>
        <button class="test-btn" onclick="testStarClick()">Simulate Star Button Click</button>
        <button class="test-btn" onclick="testRandomClick()">Simulate Random Button Click</button>
        <button class="test-btn" onclick="testMostRecentClick()">Simulate Most Recent Click</button>
        
        <p>System:</p>
        <button class="test-btn" onclick="runDiagnostics()">Run Full Diagnostics</button>
      </div>
      
      <div class="test-panel">
        <h3>System Status</h3>
        <div id="status-output"></div>
      </div>
      
      <div class="test-panel">
        <h3>Console Output</h3>
        <div class="console-area" id="console-output">
          Waiting for system initialization...<br>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- PPPage Modular System -->
<script src="modules/core.js?v=20250821"></script>
<script src="modules/posts.js?v=20250821"></script>
<script src="modules/navigation.js?v=20250821"></script>
<script src="modules/editor.js?v=20250821"></script>
<script src="modules/theme.js?v=20250821"></script>
<script src="modules/taskbar.js?v=20250821"></script>
<script src="modules/console.js?v=20250821"></script>
<script src="modules/app.js?v=20250821"></script>

<script>
function addStatus(test, status, details = '') {
  const output = document.getElementById('status-output');
  const result = document.createElement('div');
  result.className = `status ${status}`;
  result.innerHTML = `<strong>${test}:</strong> ${status.toUpperCase()}${details ? ' - ' + details : ''}`;
  output.appendChild(result);
}

function logConsole(message, type = 'info') {
  const output = document.getElementById('console-output');
  const time = new Date().toLocaleTimeString();
  const colors = { info: '#00ff00', error: '#ff4444', success: '#44ff44' };
  output.innerHTML += `<span style="color: ${colors[type] || colors.info}">[${time}] ${message}</span><br>`;
  output.scrollTop = output.scrollHeight;
}

// Capture console logs
const originalLog = console.log;
const originalError = console.error;
console.log = function(...args) {
  logConsole(args.join(' '), 'info');
  originalLog.apply(console, args);
};
console.error = function(...args) {
  logConsole(args.join(' '), 'error');
  originalError.apply(console, args);
};

// Test functions
async function testLatestDirect() {
  logConsole('Testing loadLatestPost() directly...', 'info');
  try {
    const postsModule = window.ppPage?.getModule('posts');
    if (postsModule && postsModule.loadLatestPost) {
      await postsModule.loadLatestPost();
      logConsole('Direct loadLatestPost() completed', 'success');
    } else {
      logConsole('loadLatestPost() not available', 'error');
    }
  } catch (error) {
    logConsole(`Direct loadLatestPost() error: ${error.message}`, 'error');
  }
}

async function testRandomDirect() {
  logConsole('Testing loadRandomPost() directly...', 'info');
  try {
    const postsModule = window.ppPage?.getModule('posts');
    if (postsModule && postsModule.loadRandomPost) {
      await postsModule.loadRandomPost();
      logConsole('Direct loadRandomPost() completed', 'success');
    } else {
      logConsole('loadRandomPost() not available', 'error');
    }
  } catch (error) {
    logConsole(`Direct loadRandomPost() error: ${error.message}`, 'error');
  }
}

async function testMostRecentDirect() {
  logConsole('Testing loadMostRecentPost() directly...', 'info');
  try {
    const postsModule = window.ppPage?.getModule('posts');
    if (postsModule && postsModule.loadMostRecentPost) {
      await postsModule.loadMostRecentPost();
      logConsole('Direct loadMostRecentPost() completed', 'success');
    } else {
      logConsole('loadMostRecentPost() not available', 'error');
    }
  } catch (error) {
    logConsole(`Direct loadMostRecentPost() error: ${error.message}`, 'error');
  }
}

function testStarClick() {
  logConsole('Simulating star button click...', 'info');
  const button = document.getElementById('star-button');
  if (button) {
    button.click();
    logConsole('Star button clicked', 'success');
  } else {
    logConsole('Star button not found', 'error');
  }
}

function testRandomClick() {
  logConsole('Simulating random post button click...', 'info');
  const button = document.getElementById('random-post');
  if (button) {
    button.click();
    logConsole('Random post button clicked', 'success');
  } else {
    logConsole('Random post button not found', 'error');
  }
}

function testMostRecentClick() {
  logConsole('Simulating most recent button click...', 'info');
  const button = document.getElementById('most-recent-post');
  if (button) {
    button.click();
    logConsole('Most recent button clicked', 'success');
  } else {
    logConsole('Most recent button not found', 'error');
  }
}

function runDiagnostics() {
  logConsole('Running full system diagnostics...', 'info');
  document.getElementById('status-output').innerHTML = '';
  
  // Check ppPage
  if (window.ppPage) {
    addStatus('PPPage Core', 'pass', 'Available');
    
    const postsModule = window.ppPage.getModule('posts');
    if (postsModule) {
      addStatus('Posts Module', 'pass', 'Loaded');
      addStatus('Posts Data', postsModule.posts?.length ? 'pass' : 'fail', 
        `${postsModule.posts?.length || 0} posts`);
      
      const methods = ['loadLatestPost', 'loadRandomPost', 'loadMostRecentPost'];
      methods.forEach(method => {
        addStatus(`Method ${method}`, 
          typeof postsModule[method] === 'function' ? 'pass' : 'fail');
      });
    } else {
      addStatus('Posts Module', 'fail', 'Not loaded');
    }
  } else {
    addStatus('PPPage Core', 'fail', 'Not available');
  }
  
  // Check buttons
  const buttons = [
    { id: 'star-button', name: 'Star Button' },
    { id: 'random-post', name: 'Random Post' },
    { id: 'most-recent-post', name: 'Most Recent' }
  ];
  
  buttons.forEach(({ id, name }) => {
    const button = document.getElementById(id);
    addStatus(`${name} DOM`, button ? 'pass' : 'fail');
  });
}

// Watch for post changes
const titleObserver = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.target.id === 'post-title') {
      const newTitle = mutation.target.textContent;
      if (newTitle && newTitle !== 'No post loaded') {
        logConsole(`POST LOADED: ${newTitle}`, 'success');
      }
    }
  });
});

const titleElement = document.getElementById('post-title');
if (titleElement) {
  titleObserver.observe(titleElement, { childList: true, subtree: true });
}

// Auto-run diagnostics
setTimeout(() => {
  logConsole('Auto-running diagnostics...', 'info');
  runDiagnostics();
}, 4000);
</script>

</body>
</html>
