<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taskbar Robustness Final Test</title>
  <link rel="stylesheet" href="style.css?v=20250823">
  <style>
    .test-panel {
      position: fixed;
      right: 20px;
      top: 20px;
      width: 300px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
    }
    .test-status {
      padding: 8px;
      margin: 5px 0;
      border-radius: 3px;
      font-size: 12px;
    }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    .pending { background: #fff3cd; color: #856404; }
    .test-btn {
      margin: 2px;
      padding: 5px 10px;
      font-size: 11px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .test-btn:hover { background: #0056b3; }
    .console-log {
      background: #000;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      font-size: 10px;
      height: 150px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<!-- Taskbar will be loaded by modular system -->

<div class="page-container">
  <main class="main-column">
    <header class="post-header">
      <h1 class="post-title">Taskbar Robustness Final Test</h1>
      <div class="post-date">Build: alpine (20250823)</div>
    </header>
    
    <section class="post-content">
      <p>This page tests the robustness of the taskbar system, including:</p>
      <ul>
        <li>Taskbar loading and initialization</li>
        <li>Menu click functionality</li>
        <li>Custom and Random theme switching</li>
        <li>Resilience to page reloads</li>
        <li>Error recovery</li>
      </ul>
      
      <p>The test panel on the right will automatically run tests and show results.</p>
      
      <h3>Manual Testing Instructions:</h3>
      <ol>
        <li>Click on "View" in the taskbar above</li>
        <li>Try "Custom..." and "Random" theme options</li>
        <li>Reload the page (Ctrl+R / Cmd+R)</li>
        <li>Verify taskbar still works after reload</li>
        <li>Try multiple theme switches in sequence</li>
      </ol>
    </section>
  </main>
</div>

<div class="test-panel">
  <h4>Test Results</h4>
  <div id="test-results">
    <div class="test-status pending" id="load-test">
      <strong>Taskbar Load:</strong> <span id="load-status">Testing...</span>
    </div>
    <div class="test-status pending" id="click-test">
      <strong>Menu Clicks:</strong> <span id="click-status">Testing...</span>
    </div>
    <div class="test-status pending" id="theme-test">
      <strong>Theme System:</strong> <span id="theme-status">Testing...</span>
    </div>
    <div class="test-status pending" id="custom-test">
      <strong>Custom Theme:</strong> <span id="custom-status">Testing...</span>
    </div>
    <div class="test-status pending" id="random-test">
      <strong>Random Theme:</strong> <span id="random-status">Testing...</span>
    </div>
  </div>
  
  <div style="margin-top: 10px;">
    <button class="test-btn" onclick="runAllTests()">Run All Tests</button>
    <button class="test-btn" onclick="testThemes()">Test Themes</button>
    <button class="test-btn" onclick="forceReload()">Force Reload</button>
    <button class="test-btn" onclick="clearLog()">Clear Log</button>
  </div>
  
  <div class="console-log" id="test-console"></div>
</div>

<!-- PPPage Modular System -->
<script src="modules/core.js?v=20250823"></script>
<script src="modules/posts.js?v=20250823"></script>
<script src="modules/navigation.js?v=20250823"></script>
<script src="modules/editor.js?v=20250823"></script>
<script src="modules/theme.js?v=20250823"></script>
<script src="modules/taskbar.js?v=20250823"></script>
<script src="modules/console.js?v=20250823"></script>
<script src="modules/app.js?v=20250823"></script>

<script>
let testLog = [];

function log(message) {
  const timestamp = new Date().toTimeString().split(' ')[0];
  const logMessage = `${timestamp}: ${message}`;
  testLog.push(logMessage);
  
  const console = document.getElementById('test-console');
  if (console) {
    console.innerHTML = testLog.slice(-20).join('\n');
    console.scrollTop = console.scrollHeight;
  }
}

function updateStatus(testId, status, message) {
  const element = document.getElementById(testId);
  const statusSpan = document.getElementById(testId.replace('-test', '-status'));
  
  if (element && statusSpan) {
    element.className = `test-status ${status}`;
    statusSpan.textContent = message;
  }
}

function testTaskbarLoad() {
  log('=== Testing Taskbar Load ===');
  
  const menuBar = document.querySelector('.menu-bar');
  if (!menuBar) {
    updateStatus('load-test', 'fail', 'Taskbar not found');
    log('❌ Taskbar not found in DOM');
    return false;
  }
  
  const buildIndicator = menuBar.querySelector('.build-indicator');
  if (buildIndicator && buildIndicator.textContent.includes('alpine')) {
    updateStatus('load-test', 'pass', 'Taskbar loaded with correct build');
    log('✅ Taskbar loaded with correct build indicator');
  } else {
    updateStatus('load-test', 'pass', 'Taskbar loaded (no build indicator)');
    log('✅ Taskbar loaded');
  }
  
  return true;
}

function testMenuClicks() {
  log('=== Testing Menu Clicks ===');
  
  const viewLabel = document.querySelector('[data-menu]');
  if (!viewLabel) {
    updateStatus('click-test', 'fail', 'View menu not found');
    log('❌ View menu label not found');
    return false;
  }
  
  // Test click
  log('Testing View menu click...');
  viewLabel.click();
  
  setTimeout(() => {
    const menuItem = viewLabel.closest('.menu-item');
    if (menuItem && menuItem.classList.contains('open')) {
      updateStatus('click-test', 'pass', 'Menu clicks working');
      log('✅ Menu opens on click');
      
      // Close the menu
      document.body.click();
    } else {
      updateStatus('click-test', 'fail', 'Menu does not open');
      log('❌ Menu does not open on click');
    }
  }, 200);
  
  return true;
}

function testThemeSystem() {
  log('=== Testing Theme System ===');
  
  const themeModule = window.ppPage && window.ppPage.getModule('theme');
  if (!themeModule) {
    updateStatus('theme-test', 'fail', 'Theme module not available');
    log('❌ Theme module not found');
    return false;
  }
  
  if (typeof themeModule.setTheme !== 'function') {
    updateStatus('theme-test', 'fail', 'setTheme method missing');
    log('❌ Theme module missing setTheme method');
    return false;
  }
  
  updateStatus('theme-test', 'pass', 'Theme module available');
  log('✅ Theme module found and functional');
  return true;
}

function testCustomTheme() {
  log('=== Testing Custom Theme ===');
  
  const customButton = document.querySelector('[data-mode="custom"]');
  if (!customButton) {
    updateStatus('custom-test', 'fail', 'Custom button not found');
    log('❌ Custom theme button not found');
    return false;
  }
  
  log('Clicking custom theme button...');
  customButton.click();
  
  setTimeout(() => {
    const hasCustomMode = document.body.classList.contains('custom-mode');
    const hasCustomBg = document.body.style.getPropertyValue('--bg');
    
    if (hasCustomMode || hasCustomBg) {
      updateStatus('custom-test', 'pass', 'Custom theme applied');
      log('✅ Custom theme applied successfully');
      log(`Body classes: ${document.body.className}`);
      log(`Custom bg: ${hasCustomBg}`);
    } else {
      updateStatus('custom-test', 'fail', 'Custom theme not applied');
      log('❌ Custom theme not applied');
      log(`Body classes: ${document.body.className}`);
    }
  }, 500);
  
  return true;
}

function testRandomTheme() {
  log('=== Testing Random Theme ===');
  
  const randomButton = document.querySelector('[data-mode="random"]');
  if (!randomButton) {
    updateStatus('random-test', 'fail', 'Random button not found');
    log('❌ Random theme button not found');
    return false;
  }
  
  const originalBg = document.body.style.getPropertyValue('--bg');
  
  log('Clicking random theme button...');
  randomButton.click();
  
  setTimeout(() => {
    const newBg = document.body.style.getPropertyValue('--bg');
    const hasCustomMode = document.body.classList.contains('custom-mode');
    
    if (hasCustomMode && newBg && newBg !== originalBg) {
      updateStatus('random-test', 'pass', 'Random theme generated');
      log('✅ Random theme generated successfully');
      log(`New background: ${newBg}`);
    } else {
      updateStatus('random-test', 'fail', 'Random theme not generated');
      log('❌ Random theme not generated');
      log(`Original: ${originalBg}, New: ${newBg}`);
    }
  }, 500);
  
  return true;
}

function runAllTests() {
  log('=== Starting All Tests ===');
  
  setTimeout(() => testTaskbarLoad(), 100);
  setTimeout(() => testMenuClicks(), 500);
  setTimeout(() => testThemeSystem(), 1000);
  setTimeout(() => testCustomTheme(), 1500);
  setTimeout(() => testRandomTheme(), 2500);
}

function testThemes() {
  testCustomTheme();
  setTimeout(() => testRandomTheme(), 1000);
}

function forceReload() {
  log('Reloading page...');
  window.location.reload();
}

function clearLog() {
  testLog = [];
  document.getElementById('test-console').innerHTML = '';
}

// Override console.log to capture system messages
const originalLog = console.log;
console.log = function(...args) {
  originalLog.apply(console, args);
  log(args.join(' '));
};

// Auto-run tests when page loads
setTimeout(() => {
  log('=== Auto-running tests ===');
  runAllTests();
}, 3000);

// Test resilience - check taskbar every 5 seconds
setInterval(() => {
  const menuBar = document.querySelector('.menu-bar');
  if (!menuBar) {
    log('⚠️ Taskbar missing, system should recover...');
    if (window.ensureTaskbar) {
      window.ensureTaskbar();
    }
  }
}, 5000);
</script>
</body>
</html>
